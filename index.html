<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Titan ERP SaaS 2026 - Master V42</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: {} }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            @apply bg-slate-50 text-slate-900 transition-colors duration-300 dark:bg-slate-900 dark:text-slate-100;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { @apply bg-slate-300 dark:bg-slate-700 rounded-full; }

        /* ========================================== */
        /* ARQUITETURA VISUAL DO SAAS                 */
        /* ========================================== */
        .card-titan { 
            @apply bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-100 dark:border-slate-700 shadow-sm transition-all duration-300 hover:shadow-xl; 
        }

        .input-titan { 
            @apply w-full p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl font-bold text-xs focus:border-indigo-500 dark:text-white outline-none transition-all; 
        }

        .chart-box { 
            position: relative; 
            height: 250px; 
            width: 100%; 
        }

        /* Switch Toggle Customizado para Simulação Manual */
        .toggle-checkbox:checked { 
            @apply right-0 border-indigo-500; 
            right: 0; 
            border-color: #6366f1; 
        }
        .toggle-checkbox:checked + .toggle-label { 
            @apply bg-indigo-500; 
            background-color: #6366f1; 
        }
        
        /* Animações e Range Slider */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(5px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        input[type=range] { 
            -webkit-appearance: none; 
            width: 100%; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            height: 20px; 
            width: 20px; 
            border-radius: 50%; 
            background: #6366f1; 
            cursor: pointer; 
            margin-top: -8px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.3); 
        }
        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; 
            height: 6px; 
            cursor: pointer; 
            @apply bg-slate-200 dark:bg-slate-700; 
            border-radius: 4px; 
        }
    </style>
</head>
<body class="antialiased">
    <div id="app" class="min-h-screen flex flex-col">
        
        <header class="bg-slate-900 text-white shadow-xl sticky top-0 z-50 border-b border-slate-800 print:hidden transition-colors duration-300">
            <div class="max-w-[1800px] mx-auto px-4 md:px-8 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                
                <div class="flex items-center space-x-4 w-full md:w-auto justify-between md:justify-start">
                    <div class="flex items-center space-x-4">
                        <div class="bg-gradient-to-tr from-indigo-500 to-purple-500 p-2.5 rounded-2xl shadow-lg rotate-3">
                            <i class="fas fa-rocket text-xl text-white"></i>
                        </div>
                        <div>
                            <h1 class="text-base font-black tracking-tight uppercase leading-none text-indigo-100">
                                Titan SaaS <span class="text-emerald-400">V42.0</span>
                            </h1>
                            <p class="text-[8px] text-slate-400 font-bold uppercase tracking-[0.4em] mt-1.5">
                                Código Expandido & Dark Mode Corrigido
                            </p>
                        </div>
                    </div>
                    
                    <button @click="toggleDarkMode" class="md:hidden text-slate-400 hover:text-white p-2 text-xl transition-all">
                        <i class="fas" :class="isDarkMode ? 'fa-sun text-amber-400' : 'fa-moon'"></i>
                    </button>
                </div>

                <div class="flex items-center space-x-6 w-full md:w-auto justify-between md:justify-end">
                    <button @click="toggleDarkMode" class="hidden md:block text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-xl border border-slate-700 hover:bg-slate-800 transition-all shadow-inner">
                        <i class="fas mr-2" :class="isDarkMode ? 'fa-sun text-amber-400' : 'fa-moon'"></i> 
                        {{ isDarkMode ? 'Modo Claro' : 'Modo Escuro' }}
                    </button>
                    
                    <button @click="resetarTudo" class="text-[10px] font-black text-slate-500 hover:text-red-400 transition uppercase tracking-widest px-2">
                        Zerar Tudo
                    </button>
                    
                    <button onclick="window.print()" class="bg-white text-slate-900 px-5 py-2.5 rounded-xl text-[10px] font-black transition-all active:scale-95 uppercase tracking-widest shadow-xl hover:bg-indigo-50">
                        Exportar PDF
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-[1800px] mx-auto w-full px-4 md:px-6 py-6 md:py-8 grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
            
            <div class="lg:col-span-3 space-y-4 print:hidden">
                
                <div class="bg-indigo-600 dark:bg-indigo-900 p-6 md:p-8 rounded-[2rem] shadow-xl text-white relative overflow-hidden transition-colors duration-300">
                    <div class="absolute -right-8 -bottom-8 opacity-10 text-[180px] rotate-12">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    
                    <div class="relative z-10 space-y-6">
                        <div class="text-center">
                            <label class="block text-[10px] font-black uppercase tracking-widest text-indigo-200 mb-2">
                                1. Meta de Lucro (%)
                            </label>
                            <input type="text" v-model="inputs.alvo" @input="syncAll" class="w-full bg-indigo-500/50 dark:bg-indigo-800/50 border-2 border-indigo-400 dark:border-indigo-500 rounded-3xl p-4 text-5xl font-black text-white focus:outline-none focus:border-emerald-400 text-center shadow-inner transition-colors">
                        </div>

                        <div class="pt-6 border-t border-indigo-500/50">
                            <div class="flex items-center justify-between mb-4">
                                <label class="text-[9px] font-black uppercase tracking-widest text-indigo-200">
                                    2. Modo Simulação Manual
                                </label>
                                <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="toggle" v-model="ui.modoManual" @change="toggleModoManual" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                    <label for="toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-indigo-400/50 cursor-pointer"></label>
                                </div>
                            </div>
                            
                            <div v-if="ui.modoManual" class="fade-in">
                                <input type="text" v-model="inputs.precoVenda" @input="syncAll" class="w-full bg-indigo-900/40 border-2 border-indigo-300 dark:border-indigo-500 p-3 text-2xl font-black text-white rounded-2xl focus:outline-none text-center shadow-lg placeholder-indigo-300" placeholder="R$ 0,00">
                                <p class="text-[8px] text-indigo-300 mt-2 font-black uppercase tracking-widest text-center">
                                    Testando o lucro deste preço.
                                </p>
                            </div>
                            <div v-else class="text-center p-3 bg-indigo-500/20 rounded-2xl border border-indigo-500/30">
                                <p class="text-[9px] text-indigo-200 font-bold uppercase tracking-widest">
                                    <i class="fas fa-robot mr-2"></i> Preço Ideal Automático
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-[2rem] border border-slate-200 dark:border-slate-700 shadow-sm overflow-hidden transition-colors duration-300">
                    
                    <div class="border-b border-slate-100 dark:border-slate-700">
                        <button @click="toggleAccordion('produto')" class="w-full px-6 py-5 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                            <h2 class="text-[11px] font-black text-slate-600 dark:text-slate-300 uppercase tracking-widest flex items-center">
                                <i class="fas fa-box-open mr-3 text-indigo-500"></i> Custos Unitários
                            </h2>
                            <i class="fas fa-chevron-down text-slate-400" :class="{'rotate-180': accordions.produto}"></i>
                        </button>
                        
                        <div v-show="accordions.produto" class="p-6 space-y-5 fade-in bg-white dark:bg-slate-800 border-l-4 border-indigo-500 transition-colors">
                            <input type="text" v-model="inputs.nomeProd" @input="salvar" class="input-titan" placeholder="Descrição do Item">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1.5 ml-1">Custo Compra</label>
                                    <input type="text" v-model="inputs.custo" @input="syncAll" class="input-titan">
                                </div>
                                <div>
                                    <label class="block text-[9px] font-bold text-slate-400 uppercase mb-1.5 ml-1">Embalagem</label>
                                    <input type="text" v-model="inputs.embalagem" @input="syncAll" class="input-titan">
                                </div>
                            </div>
                            
                            <div class="bg-indigo-50 dark:bg-indigo-900/30 p-4 rounded-2xl border border-indigo-100 dark:border-indigo-800/50 transition-colors">
                                <label class="block text-[9px] font-black text-indigo-700 dark:text-indigo-400 uppercase mb-2 tracking-widest flex items-center cursor-help" title="Use este campo para adicionar um valor fixo de lucro ou custo direto por peça.">
                                    Adicional Operacional (R$) <i class="fas fa-question-circle ml-2 opacity-50"></i>
                                </label>
                                <input type="text" v-model="inputs.custoFixoDireto" @input="syncAll" class="input-titan !bg-white dark:!bg-slate-900 border-indigo-200 dark:border-indigo-700" placeholder="Ex: R$ 10,00">
                            </div>
                            
                            <div class="p-4 bg-slate-900 rounded-xl flex justify-between items-center text-white shadow-inner">
                                <span class="text-[9px] font-black uppercase tracking-widest">CMV Base Final:</span>
                                <span class="font-black text-lg">R$ {{ totalCustoDiretoUnidade.toFixed(2) }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="border-b border-slate-100 dark:border-slate-700">
                        <button @click="toggleAccordion('volume')" class="w-full px-6 py-5 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                            <h2 class="text-[11px] font-black text-slate-600 dark:text-slate-300 uppercase tracking-widest flex items-center">
                                <i class="fas fa-chart-pie mr-3 text-amber-500"></i> Despesas Fixas
                            </h2>
                            <div class="flex items-center space-x-3">
                                <span class="text-[9px] font-black bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-400 px-2 py-1 rounded-lg">
                                    R$ {{ totalFixas.toFixed(2) }}
                                </span>
                                <i class="fas fa-chevron-down text-slate-400" :class="{'rotate-180': accordions.volume}"></i>
                            </div>
                        </button>
                        
                        <div v-show="accordions.volume" class="p-6 space-y-6 fade-in bg-white dark:bg-slate-800 border-l-4 border-amber-500 transition-colors">
                            <div class="bg-amber-50 dark:bg-amber-900/20 rounded-2xl p-5 border border-amber-100 dark:border-amber-800/50">
                                <div class="flex justify-between items-end mb-4">
                                    <label class="text-[10px] font-black text-amber-800 dark:text-amber-400 uppercase tracking-widest cursor-help" title="Deslize para ver o impacto do volume no custo de cada peça.">
                                        Vendas Estimadas (Mês) <i class="fas fa-question-circle opacity-50"></i>
                                    </label>
                                    <input type="text" v-model="inputs.volume" @input="syncAll" class="w-20 p-2 border-2 border-amber-200 dark:border-amber-700 rounded-xl text-xs text-center font-black bg-white dark:bg-slate-900 dark:text-white outline-none">
                                </div>
                                <input type="range" min="1" max="5000" step="10" v-model="inputs.volume" @input="syncAll">
                                <div class="mt-4 pt-4 border-t border-amber-200/50 dark:border-amber-800/50 flex justify-between items-center">
                                    <span class="text-[9px] font-black text-amber-700 dark:text-amber-500 uppercase tracking-widest">Rateio por Peça:</span>
                                    <span class="text-lg font-black text-amber-900 dark:text-amber-400 tracking-tighter">R$ {{ rateio.toFixed(2) }}</span>
                                </div>
                            </div>
                            
                            <div class="space-y-2 max-h-40 overflow-y-auto pr-1">
                                <div v-for="(d, i) in despesas" :key="i" class="flex items-center space-x-2">
                                    <input type="text" v-model="d.nome" @input="salvar" class="flex-grow p-2.5 text-[10px] border border-slate-200 dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-900 dark:text-white font-bold" placeholder="Nome da Conta">
                                    <input type="text" v-model="d.valor" @input="syncAll" class="w-16 p-2.5 text-[10px] border border-slate-200 dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-900 dark:text-white font-black text-right">
                                    <button @click="removerDespesa(i)" class="text-slate-400 hover:text-red-500 p-1 transition-colors">
                                        <i class="fas fa-trash-can"></i>
                                    </button>
                                </div>
                            </div>
                            <button @click="adicionarDespesa" class="w-full py-2.5 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl text-[9px] font-black text-slate-500 dark:text-slate-400 hover:text-amber-600 transition-colors uppercase tracking-widest">
                                + Adicionar Nova Conta
                            </button>
                        </div>
                    </div>

                    <div>
                        <button @click="toggleAccordion('impostos')" class="w-full px-6 py-5 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                            <h2 class="text-[11px] font-black text-slate-600 dark:text-slate-300 uppercase tracking-widest flex items-center">
                                <i class="fas fa-landmark mr-3 text-blue-500"></i> Tributos & Perdas
                            </h2>
                            <i class="fas fa-chevron-down text-slate-400" :class="{'rotate-180': accordions.impostos}"></i>
                        </button>
                        
                        <div v-show="accordions.impostos" class="p-6 space-y-4 fade-in bg-white dark:bg-slate-800 border-l-4 border-blue-500 transition-colors">
                            <div class="flex items-center justify-between">
                                <h2 class="text-[10px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-widest cursor-help" title="Alíquota aplicada sobre o Faturamento Bruto (Simples Nacional).">
                                    Imposto NF-e (%) <i class="fas fa-question-circle opacity-50 ml-1"></i>
                                </h2>
                                <input type="text" v-model="inputs.imposto" @input="syncAll" class="input-titan !w-20 !text-right">
                            </div>
                            <div class="flex items-center justify-between">
                                <h2 class="text-[10px] font-black text-orange-500 uppercase tracking-widest cursor-help" title="Margem provisionada para devoluções, roubos de carga ou avarias.">
                                    Perdas (%) <i class="fas fa-question-circle opacity-50 ml-1"></i>
                                </h2>
                                <input type="text" v-model="inputs.perdas" @input="syncAll" class="input-titan !w-20 !text-right !text-orange-600">
                            </div>
                        </div>
                    </div>
                </div>
                
                <button @click="salvarNoBanco" class="w-full py-5 bg-slate-900 dark:bg-indigo-600 hover:bg-black dark:hover:bg-indigo-500 text-white rounded-[2rem] font-black text-[11px] shadow-2xl transition-all active:scale-95 uppercase tracking-[0.2em] print:hidden">
                    <i class="fas fa-save mr-3 text-emerald-400"></i> Arquivar Precificação
                </button>
            </div>

            <div class="lg:col-span-9 space-y-6 md:space-y-8">
                
                <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 md:gap-8">
                    <div class="xl:col-span-8 card-titan p-6 md:p-8 shadow-lg">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-[11px] md:text-[12px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-[0.3em] flex items-center">
                                <i class="fas fa-chart-line mr-3 text-indigo-500 text-lg"></i> Monitor Omnichannel
                            </h2>
                        </div>
                        <div class="chart-box">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>

                    <div class="xl:col-span-4 card-titan overflow-hidden hidden md:block">
                        <table class="w-full text-left text-[11px] border-collapse">
                            <thead>
                                <tr class="bg-slate-50 dark:bg-slate-900/50 text-slate-400 dark:text-slate-500 font-black uppercase tracking-widest border-b dark:border-slate-700">
                                    <th class="py-4 px-6">Plataforma</th>
                                    <th class="text-right px-6">Preço Ideal</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50 dark:divide-slate-700 font-bold text-slate-600 dark:text-slate-300">
                                <tr v-for="mkp in marketplaces" :key="mkp.id" class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                                    <td class="py-3 px-6 flex items-center">
                                        <i :class="mkp.icon" :style="{color: mkp.corIcone}" class="text-lg mr-3 w-5 text-center"></i> 
                                        {{ mkp.nome.split(' ')[0] }}
                                    </td>
                                    <td class="text-right px-6 font-black tracking-tighter">
                                        R$ {{ calcPrecoIdeal(mkp).toFixed(2) }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 2xl:grid-cols-3 gap-6 md:gap-8">
                    <div v-for="mkp in marketplaces" :key="mkp.id" class="card-titan relative overflow-hidden flex flex-col group transition-all" :class="{'simulando-ativo dark:!border-indigo-500/50 dark:bg-slate-800': sNum(inputs.precoVenda) > 0 && ui.modoManual}">
                        
                        <div class="absolute left-0 top-0 bottom-0 w-2.5 transition-all duration-700 shadow-xl" :class="calcLucro(mkp) >= 0 ? 'bg-emerald-500' : 'bg-red-500'"></div>
                        
                        <div v-if="mkp.id === bestMarketplaceId" class="absolute top-0 right-8 bg-emerald-500 text-white text-[8px] font-black px-3 py-1 rounded-b-lg shadow-md uppercase tracking-widest flex items-center animate-fade-in">
                            <i class="fas fa-crown mr-1"></i> Melhor Margem
                        </div>

                        <div class="p-6 px-8 flex justify-between items-center border-b border-slate-100 dark:border-slate-700">
                            <div class="flex items-center space-x-4">
                                <div class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-900 flex items-center justify-center shadow-inner border border-slate-100 dark:border-slate-800 transition-colors">
                                    <i :class="mkp.icon" :style="{color: mkp.corIcone}" class="text-xl"></i>
                                </div>
                                <div class="flex flex-col">
                                    <h3 class="font-black text-sm uppercase tracking-widest leading-none dark:text-slate-200">
                                        {{ mkp.nome.split(' ')[0] }}
                                    </h3>
                                    <div class="flex flex-wrap gap-1 mt-1.5">
                                        
                                        <span v-if="mkp.id === 2" class="text-[7px] font-black px-1.5 py-0.5 rounded-md uppercase tracking-tighter" :class="getSmartFees(mkp, (ui.modoManual && sNum(inputs.precoVenda) ? sNum(inputs.precoVenda) : calcPrecoIdeal(mkp))).log === 0 ? 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-400' : 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300'">
                                            {{ getSmartFees(mkp, (ui.modoManual && sNum(inputs.precoVenda) ? sNum(inputs.precoVenda) : calcPrecoIdeal(mkp))).log === 0 ? 'Taxa Fixa ML' : 'Frete ML Ativo' }}
                                        </span>
                                        
                                        <span v-if="mkp.id === 1" class="text-[7px] font-black px-1.5 py-0.5 rounded-md uppercase tracking-tighter bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-400">
                                            Fixo TIER: R$ {{ getSmartFees(mkp, (ui.modoManual && sNum(inputs.precoVenda) ? sNum(inputs.precoVenda) : calcPrecoIdeal(mkp))).fix.toFixed(2) }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <button @click="mkp.edit = !mkp.edit" class="text-[9px] font-black bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 px-3 py-1.5 rounded-lg shadow-sm hover:shadow-md transition uppercase dark:text-slate-300">
                                <i class="fas fa-cog"></i> Taxas
                            </button>
                        </div>

                        <div v-show="mkp.edit" class="p-6 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-100 dark:border-slate-700 grid grid-cols-2 gap-4 animate-fade-in transition-colors">
                            <div>
                                <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">Comissão Base %</label>
                                <input type="text" v-model="mkp.com" @input="syncAll" class="input-titan !p-2">
                            </div>
                            <div>
                                <label class="text-[9px] font-black text-blue-500 uppercase block mb-1">Invest. Ads %</label>
                                <input type="text" v-model="mkp.ads" @input="syncAll" class="input-titan !p-2 dark:!bg-blue-900/20">
                            </div>
                            <div>
                                <label class="text-[9px] font-black text-purple-600 uppercase block mb-1">Afiliados %</label>
                                <input type="text" v-model="mkp.afi" @input="syncAll" class="input-titan !p-2 dark:!bg-purple-900/20">
                            </div>
                            <div>
                                <label class="text-[9px] font-black text-amber-600 uppercase block mb-1 cursor-help" title="Bancário: Calculada sobre o valor LÍQUIDO repassado pela plataforma.">
                                    Antecipação % <i class="fas fa-question-circle opacity-50"></i>
                                </label>
                                <input type="text" v-model="mkp.ant" @input="syncAll" class="input-titan !p-2 dark:!bg-amber-900/20">
                            </div>
                            
                            <div v-if="mkp.id === 3" class="col-span-2 p-3 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-100 dark:border-emerald-800 flex items-center justify-between">
                                <label class="text-[9px] font-black text-emerald-800 dark:text-emerald-400 uppercase tracking-widest">
                                    <i class="fas fa-truck-fast mr-2"></i> Frete SFP (+6% | Max 50)
                                </label>
                                <input type="checkbox" v-model="mkp.useSFP" @change="syncAll" class="w-5 h-5 rounded text-emerald-600 cursor-pointer">
                            </div>

                            <div class="relative">
                                <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">Taxa Fixa R$</label>
                                <input type="text" v-model="mkp.fixo" @input="syncAll" class="input-titan !p-2">
                                <div v-if="mkp.id === 2 && (ui.modoManual && sNum(inputs.precoVenda) ? sNum(inputs.precoVenda) : calcPrecoIdeal(mkp)) >= 79" class="absolute inset-x-0 bottom-0 top-[20px] bg-slate-100/90 dark:bg-slate-800/90 rounded-xl flex items-center justify-center text-[7px] font-black text-slate-500 uppercase backdrop-blur-sm">
                                    Isento (>79)
                                </div>
                            </div>
                            <div class="relative">
                                <label class="text-[9px] font-black text-slate-400 uppercase block mb-1">Frete Fixo R$</label>
                                <input type="text" v-model="mkp.log" @input="syncAll" class="input-titan !p-2">
                                <div v-if="mkp.id === 2 && (ui.modoManual && sNum(inputs.precoVenda) ? sNum(inputs.precoVenda) : calcPrecoIdeal(mkp)) < 79" class="absolute inset-x-0 bottom-0 top-[20px] bg-slate-100/90 dark:bg-slate-800/90 rounded-xl flex items-center justify-center text-[7px] font-black text-slate-500 uppercase backdrop-blur-sm">
                                    Isento (<79)
                                </div>
                            </div>
                        </div>

                        <div class="p-8 flex-grow flex flex-col space-y-8">
                            
                            <div class="p-8 border border-slate-100 dark:border-slate-700 rounded-[2rem] text-center shadow-inner relative overflow-hidden transition-all duration-500" :class="{'bg-emerald-50 dark:bg-emerald-900/20 border-emerald-100 dark:border-emerald-800': !ui.modoManual, 'bg-blue-50 dark:bg-blue-900/20 border-blue-100 dark:border-blue-800': ui.modoManual}">
                                <p class="text-[11px] font-black uppercase mb-3 tracking-[0.3em]" :class="ui.modoManual ? 'text-blue-600 dark:text-blue-400' : 'text-emerald-600 dark:text-emerald-400'">
                                    {{ ui.modoManual ? 'Simulação Manual' : 'Preço Ideal Sugerido' }}
                                </p>
                                <p class="text-6xl font-black tracking-tighter leading-none" :class="ui.modoManual ? 'text-blue-900 dark:text-blue-100' : 'text-emerald-900 dark:text-emerald-100'">
                                    R$ {{ ui.modoManual && sNum(inputs.precoVenda) > 0 ? sNum(inputs.precoVenda).toFixed(2) : calcPrecoIdeal(mkp).toFixed(2) }}
                                </p>
                                <div class="mt-4 text-[9px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest">
                                    {{ ui.modoManual ? 'Preço P/ Meta Exata: R$ ' + calcPrecoIdeal(mkp).toFixed(2) : 'Atinge exatos ' + sNum(inputs.alvo) + '% lucro' }}
                                </div>
                            </div>

                            <div class="pt-6 border-t border-slate-100 dark:border-slate-700 grid grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <p class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest flex items-center">
                                        Lucro Líquido <i :class="ui.modoManual ? 'fas fa-hand-pointer ml-2 text-blue-500' : 'fas fa-robot ml-2 text-emerald-500'"></i>
                                    </p>
                                    <p class="text-4xl font-black leading-none tracking-tighter" :class="calcLucro(mkp) >= 0 ? 'text-slate-900 dark:text-white' : 'text-red-600 dark:text-red-400'">
                                        R$ {{ calcLucro(mkp).toFixed(2) }}
                                    </p>
                                </div>
                                <div class="text-right space-y-2">
                                    <p class="text-[10px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">Margem Final</p>
                                    <p class="text-3xl font-black leading-none mt-1" :class="calcLucro(mkp) >= 0 ? 'text-emerald-500' : 'text-red-400'">
                                        {{ calcMargem(mkp).toFixed(1) }}%
                                    </p>
                                </div>
                            </div>

                            <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-3 overflow-hidden shadow-inner">
                                <div class="h-full transition-all duration-1000 rounded-full" 
                                     :class="calcMargem(mkp) >= sNum(inputs.alvo) ? 'bg-emerald-500' : (calcMargem(mkp) > 0 ? 'bg-amber-400' : 'bg-red-500')" 
                                     :style="{ width: Math.min(Math.max((calcMargem(mkp)/sNum(inputs.alvo))*100, 0), 100) + '%' }">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="banco.length > 0" class="bg-slate-900 dark:bg-slate-800 rounded-[3rem] p-10 md:p-14 shadow-2xl mt-12 border border-slate-800 dark:border-slate-700 print:hidden transition-colors">
                    <h2 class="text-[12px] font-black text-emerald-400 uppercase tracking-[0.6em] mb-8 flex items-center">
                        <i class="fas fa-database mr-4 text-2xl"></i> Banco de Cenários Salvos
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div v-for="(b, i) in banco" :key="i" class="flex flex-col sm:flex-row items-center justify-between p-6 bg-white/5 rounded-[2rem] border border-white/5 hover:bg-white/10 transition-all">
                            <div class="mb-4 sm:mb-0 text-center sm:text-left">
                                <h4 class="text-white font-extrabold text-xl uppercase">{{ b.nome }}</h4>
                                <div class="flex gap-6 mt-3 justify-center sm:justify-start">
                                    <div class="flex flex-col">
                                        <span class="text-[9px] text-slate-500 uppercase tracking-widest border-b border-slate-700 pb-1 mb-1">Preço Sugerido</span>
                                        <span class="text-lg font-black text-emerald-400">R$ {{ b.venda }}</span>
                                    </div>
                                    <div class="flex flex-col border-l border-slate-700 pl-6">
                                        <span class="text-[9px] text-slate-500 uppercase tracking-widest border-b border-slate-700 pb-1 mb-1">Meta</span>
                                        <span class="text-lg font-black text-slate-200">{{ b.alvo }}%</span>
                                    </div>
                                </div>
                            </div>
                            <button @click="removerProduto(i)" class="bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white px-6 py-3 rounded-xl text-[10px] font-black uppercase transition-all w-full sm:w-auto">
                                Excluir
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue
        
        createApp({
            data() {
                return {
                    // Estados da Interface (Dark Mode & UX)
                    isDarkMode: false,
                    accordions: { 
                        produto: true, 
                        volume: false, 
                        impostos: false 
                    },
                    ui: { 
                        modoManual: false 
                    },
                    
                    // Configurações e Custos do Negócio
                    inputs: { 
                        nomeProd: '', 
                        precoVenda: '0,00', 
                        custo: '45,00', 
                        embalagem: '1,00', 
                        custoFixoDireto: '0,00', 
                        perdas: '1,0', 
                        volume: '3000', 
                        imposto: '10,0', 
                        alvo: '15,0' 
                    },
                    
                    // Despesas Fixas em Formato Expandido
                    despesas: [
                        { 
                            nome: 'Aluguel do Galpão', 
                            valor: '1200' 
                        }, 
                        { 
                            nome: 'Sistemas ERP (Bling)', 
                            valor: '450' 
                        }, 
                        { 
                            nome: 'Folha de Pagamento', 
                            valor: '1300' 
                        }, 
                        { 
                            nome: 'Energia Elétrica', 
                            valor: '300' 
                        }
                    ],
                    
                    // Estrutura de Marketplaces Expandida para Auditoria Clara (+80 linhas)
                    marketplaces: [
                        { 
                            id: 1, 
                            nome: 'Shopee Brasil', 
                            icon: 'fa-solid fa-bag-shopping', 
                            corIcone: '#f97316', 
                            com: '14', 
                            ads: '0', 
                            afi: '0', 
                            ant: '0', 
                            fixo: '4', 
                            log: '0', 
                            edit: false 
                        },
                        { 
                            id: 2, 
                            nome: 'Mercado Livre', 
                            icon: 'fa-solid fa-handshake', 
                            corIcone: '#eab308', 
                            com: '19', 
                            ads: '0', 
                            afi: '0', 
                            ant: '0', 
                            fixo: '6.75', 
                            log: '18,50', 
                            edit: false 
                        },
                        { 
                            id: 3, 
                            nome: 'TikTok Shop', 
                            icon: 'fa-brands fa-tiktok', 
                            corIcone: '#0f172a', 
                            com: '6', 
                            ads: '5', 
                            afi: '10', 
                            ant: '0', 
                            fixo: '4', 
                            log: '0', 
                            edit: false, 
                            useSFP: true 
                        },
                        { 
                            id: 4, 
                            nome: 'Amazon BR', 
                            icon: 'fa-brands fa-amazon', 
                            corIcone: '#0ea5e9', 
                            com: '14', 
                            ads: '0', 
                            afi: '0', 
                            ant: '0', 
                            fixo: '0', 
                            log: '11,95', 
                            edit: false 
                        },
                        { 
                            id: 5, 
                            nome: 'Shein Brasil', 
                            icon: 'fa-solid fa-shirt', 
                            corIcone: '#1e293b', 
                            com: '16', 
                            ads: '0', 
                            afi: '0', 
                            ant: '0', 
                            fixo: '0', 
                            log: '0', 
                            edit: false 
                        },
                        { 
                            id: 6, 
                            nome: 'Magazine Luiza', 
                            icon: 'fa-solid fa-cart-shopping', 
                            corIcone: '#3b82f6', 
                            com: '16', 
                            ads: '0', 
                            afi: '0', 
                            ant: '0', 
                            fixo: '3', 
                            log: '0', 
                            edit: false 
                        },
                        { 
                            id: 7, 
                            nome: 'Netshoes', 
                            icon: 'fa-solid fa-person-running', 
                            corIcone: '#8b5cf6', 
                            com: '18', 
                            ads: '0', 
                            afi: '0', 
                            ant: '0', 
                            fixo: '5', 
                            log: '0', 
                            edit: false 
                        },
                        { 
                            id: 8, 
                            nome: 'Temu Direto', 
                            icon: 'fa-solid fa-box', 
                            corIcone: '#ef4444', 
                            com: '15', 
                            ads: '0', 
                            afi: '0', 
                            ant: '0', 
                            fixo: '0', 
                            log: '0', 
                            edit: false 
                        }
                    ],
                    banco: [], 
                    chart: null
                }
            },
            
            computed: {
                // Cálculo de Rateio Base
                totalFixas() { 
                    return this.despesas.reduce((acc, cur) => acc + this.sNum(cur.valor), 0); 
                },
                rateio() { 
                    const v = this.sNum(this.inputs.volume); 
                    return v > 0 ? this.totalFixas / v : 0; 
                },
                // Cálculo Híbrido: Compra + Embalagem + Adicional Fixo Direto
                totalCustoDiretoUnidade() { 
                    return this.sNum(this.inputs.custo) + this.sNum(this.inputs.embalagem) + this.sNum(this.inputs.custoFixoDireto); 
                },
                // Inteligência para o Badge de Recomendação
                bestMarketplaceId() {
                    let maxLucro = -999999;
                    let bestId = null;
                    this.marketplaces.forEach(mkp => {
                        let lucro = this.calcMargem(mkp);
                        if (lucro > maxLucro) { 
                            maxLucro = lucro; 
                            bestId = mkp.id; 
                        }
                    });
                    return bestId;
                }
            },
            
            watch: {
                // Monitora a troca de Tema Claro/Escuro
                isDarkMode(newVal) { 
                    localStorage.setItem('v42_darkmode', newVal);
                    
                    // CORREÇÃO: Aplica a classe diretamente na raiz do HTML para o Tailwind reconhecer
                    if(newVal) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                    
                    this.updateChart(); 
                }
            },
            
            methods: {
                // Controles de UI
                toggleDarkMode() { 
                    this.isDarkMode = !this.isDarkMode; 
                },
                toggleAccordion(section) { 
                    this.accordions[section] = !this.accordions[section]; 
                },
                toggleModoManual() { 
                    // Se desligar o modo manual, zera o campo para evitar confusão matemática
                    if(!this.ui.modoManual) {
                        this.inputs.precoVenda = '0,00'; 
                    }
                    this.syncAll(); 
                },
                
                // Conversão de Máscara de Moeda
                sNum(v) { 
                    if (!v) return 0; 
                    const clean = v.toString().replace(',', '.').replace(/[^\d.-]/g, ''); 
                    return parseFloat(clean) || 0; 
                },
                
                // Funções de Banco de Dados Local (LocalStorage)
                syncAll() { 
                    this.salvar(); 
                    this.updateChart(); 
                },
                adicionarDespesa() { 
                    this.despesas.push({ nome: '', valor: '' }); 
                    this.salvar(); 
                },
                removerDespesa(i) { 
                    this.despesas.splice(i, 1); 
                    this.syncAll(); 
                },
                salvar() { 
                    localStorage.setItem('v42_inputs', JSON.stringify(this.inputs)); 
                    localStorage.setItem('v42_despesas', JSON.stringify(this.despesas)); 
                    localStorage.setItem('v42_marketplaces', JSON.stringify(this.marketplaces)); 
                    localStorage.setItem('v42_ui', JSON.stringify(this.ui)); 
                },
                
                // ========================================== //
                // MOTOR DE AUDITORIA: GATILHOS (MARÇO/2026)  //
                // ========================================== //
                getSmartFees(mkp, precoRef) {
                    let com = this.sNum(mkp.com); 
                    let fix = this.sNum(mkp.fixo); 
                    let log = this.sNum(mkp.log);
                    
                    // AUDITORIA DO MERCADO LIVRE (Gatilho de R$ 79,00)
                    if (mkp.id === 2) { 
                        if (precoRef < 79.00) { 
                            // Abaixo de 79: O Custo de Frete é ZERADO forçadamente
                            log = 0; 
                            
                            // Aplica a tabela progressiva correta de taxa fixa
                            if (precoRef >= 50.00) { 
                                fix = 6.75; 
                            } else if (precoRef >= 29.00) { 
                                fix = 6.50; 
                            } else { 
                                fix = 6.25; 
                            }
                        } 
                        else { 
                            // Acima de 79: A Taxa Fixa é isenta
                            fix = 0; 
                            
                            // Se o usuário tiver deixado o frete em zero, o sistema restaura a base
                            if (log === 0) { 
                                log = 18.50; 
                            } 
                        } 
                    }
                    
                    // AUDITORIA DA SHOPEE (Comissão unificada 14% e Tiers Fixos)
                    if (mkp.id === 1) { 
                        com = 14; 
                        
                        // Regra de transição oficial
                        if (precoRef < 8.00) { 
                            fix = precoRef / 2; // Teto de 50%
                        } else if (precoRef < 80.00) { 
                            fix = 4.00; // Tier Básico
                        } else if (precoRef < 200.00) { 
                            fix = 20.00; // Tier Intermediário
                        } else { 
                            fix = 26.00; // Tier Máximo
                        }
                    }
                    
                    return { com, fix, log };
                },

                // ========================================== //
                // MOTOR DE PRECIFICAÇÃO: MARKUP REVERSO      //
                // ========================================== //
                calcPrecoIdeal(mkp) {
                    let resultPrice = 100;
                    
                    // Loop triplo para garantir que gatilhos como o de 79 reais estabilizem a matemática
                    for (let i = 0; i < 3; i++) {
                        let fees = this.getSmartFees(mkp, resultPrice);
                        
                        // Passo 1: Impostos e Marketing (Calculados sobre Faturamento Bruto)
                        let percGross = (fees.com + this.sNum(mkp.ads) + this.sNum(mkp.afi) + this.sNum(this.inputs.imposto) + this.sNum(this.inputs.perdas) + this.sNum(this.inputs.alvo)) / 100;
                        
                        // Passo 2: Antecipação Bancária (Calculada APENAS sobre Repasse Líquido)
                        let percAntEffective = (this.sNum(mkp.ant) / 100) * (1 - (fees.com / 100));
                        
                        let totalPercRetenção = percGross + percAntEffective;
                        
                        // Passo 3: Custos Fixos na Plataforma (Frete Fixo + Taxa Fixa)
                        let extraMoney = (fees.fix + fees.log) * (1 - (this.sNum(mkp.ant) / 100));

                        // Passo 4: Regra de Exceção TIKTOK SFP Limitada a R$ 50
                        if(mkp.id === 3 && mkp.useSFP) {
                            const precoProvisorio = (this.totalCustoDiretoUnidade + this.rateio + extraMoney) / (1 - totalPercRetenção - 0.06);
                            if(precoProvisorio * 0.06 > 50) {
                                extraMoney += 50; 
                            } else {
                                totalPercRetenção += 0.06;
                            }
                        }
                        
                        // Proteção contra divisão por zero ou negativa
                        if (totalPercRetenção >= 1) return 0;
                        
                        // Execução da Fórmula Final
                        resultPrice = (this.totalCustoDiretoUnidade + this.rateio + extraMoney) / (1 - totalPercRetenção);
                    }
                    return resultPrice;
                },

                // ========================================== //
                // CÁLCULO DO LUCRO LÍQUIDO REAL (DRE)        //
                // ========================================== //
                calcLucro(mkp) {
                    // Define se usa o preço digitado manualmente ou o calculado pelo robô
                    const preco = this.ui.modoManual && this.sNum(this.inputs.precoVenda) > 0 ? this.sNum(this.inputs.precoVenda) : this.calcPrecoIdeal(mkp);
                    const f = this.getSmartFees(mkp, preco);
                    
                    // Cálculo do Repasse Real para aplicar a Antecipação
                    const repasseSemAntecipacao = preco - (preco * (f.com / 100)) - f.fix - f.log;
                    const custoAntecipacao = repasseSemAntecipacao * (this.sNum(mkp.ant) / 100);
                    
                    // Custo do Frete Grátis TikTok
                    let tiktokFeeSFP = (mkp.id === 3 && mkp.useSFP) ? Math.min(preco * 0.06, 50) : 0;
                    
                    // Custo Tributário e Campanhas
                    const impostosEMarketing = (this.sNum(this.inputs.imposto) + this.sNum(mkp.ads) + this.sNum(mkp.afi) + this.sNum(this.inputs.perdas)) / 100;
                    
                    // Retorno Final Líquido
                    return preco - (preco * impostosEMarketing) - tiktokFeeSFP - (preco * (f.com / 100)) - f.fix - f.log - custoAntecipacao - this.totalCustoDiretoUnidade - this.rateio;
                },

                calcMargem(mkp) { 
                    const preco = this.ui.modoManual && this.sNum(this.inputs.precoVenda) > 0 ? this.sNum(this.inputs.precoVenda) : this.calcPrecoIdeal(mkp); 
                    return preco > 0 ? (this.calcLucro(mkp) / preco) * 100 : 0; 
                },

                // ========================================== //
                // GESTÃO ANALÍTICA: CHART.JS GRAPHICS        //
                // ========================================== //
                initChart() {
                    const ctx = document.getElementById('priceChart').getContext('2d');
                    this.chart = new Chart(ctx, { 
                        type: 'bar', 
                        data: { 
                            labels: this.marketplaces.map(m => m.nome.split(' ')[0]), 
                            datasets: [{ 
                                label: 'Preço Sugerido (R$)', 
                                data: this.marketplaces.map(m => this.calcPrecoIdeal(m)), 
                                backgroundColor: '#6366f1', 
                                borderRadius: 8, 
                                barThickness: 30 
                            }] 
                        }, 
                        options: { 
                            maintainAspectRatio: false, 
                            plugins: { legend: { display: false } }, 
                            scales: { 
                                y: { 
                                    beginAtZero: true, 
                                    grid: { color: this.isDarkMode ? '#334155' : '#f1f5f9' }, 
                                    ticks: { color: this.isDarkMode ? '#94a3b8' : '#64748b' } 
                                }, 
                                x: { 
                                    grid: { display: false }, 
                                    ticks: { font: { weight: 'bold' }, color: this.isDarkMode ? '#94a3b8' : '#64748b' } 
                                } 
                            } 
                        } 
                    });
                },
                updateChart() { 
                    if(this.chart) { 
                        this.chart.data.datasets[0].data = this.marketplaces.map(m => this.calcPrecoIdeal(m)); 
                        
                        // Força a atualização visual do gráfico quando o Dark Mode é ativado
                        this.chart.options.scales.y.grid.color = this.isDarkMode ? '#334155' : '#f1f5f9';
                        this.chart.options.scales.y.ticks.color = this.isDarkMode ? '#94a3b8' : '#64748b';
                        this.chart.options.scales.x.ticks.color = this.isDarkMode ? '#94a3b8' : '#64748b';
                        
                        this.chart.update(); 
                    } 
                },
                
                // ========================================== //
                // CONTROLE DE HISTÓRICO E ARQUIVAMENTO       //
                // ========================================== //
                salvarNoBanco() { 
                    if(!this.inputs.nomeProd) { alert('Aviso: Informe o nome do produto para salvar!'); return; } 
                    this.banco.unshift({ 
                        nome: this.inputs.nomeProd, 
                        venda: this.calcPrecoIdeal(this.marketplaces[0]).toFixed(2), 
                        alvo: this.inputs.alvo 
                    }); 
                    localStorage.setItem('v42_banco', JSON.stringify(this.banco)); 
                },
                removerProduto(i) { 
                    this.banco.splice(i, 1); 
                    localStorage.setItem('v42_banco', JSON.stringify(this.banco)); 
                },
                resetarTudo() { 
                    if(confirm('Atenção: Isso vai apagar todas as contas e o histórico salvo. Deseja continuar?')) { 
                        localStorage.clear(); 
                        location.reload(); 
                    }
                }
            },
            
            // Evento disparado quando o app termina de carregar na tela
            mounted() {
                // Recupera a memória de trabalho do Titan
                const i = localStorage.getItem('v42_inputs'); if (i) this.inputs = JSON.parse(i);
                const d = localStorage.getItem('v42_despesas'); if (d) this.despesas = JSON.parse(d);
                const m = localStorage.getItem('v42_marketplaces'); if (m) this.marketplaces = JSON.parse(m);
                const b = localStorage.getItem('v42_banco'); if (b) this.banco = JSON.parse(b);
                const ui = localStorage.getItem('v42_ui'); if (ui) this.ui = JSON.parse(ui);
                
                // Iniciação do Dark Mode nativo (Aplica classe na tag HTML raiz)
                const dm = localStorage.getItem('v42_darkmode'); 
                if (dm !== null) { 
                    this.isDarkMode = JSON.parse(dm); 
                    if(this.isDarkMode) {
                        document.documentElement.classList.add('dark');
                    }
                }
                
                // Proteção de Cache: Reseta os marketplaces se a versão antiga não tinha ícones
                if(!this.marketplaces[0].icon) { 
                    localStorage.removeItem('v42_marketplaces'); 
                    location.reload(); 
                }
                
                // Renderiza o Gráfico com as cores corretas do tema
                this.initChart();
            }
        }).mount('#app')
    </script>
</body>
</html>
